<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Builder — Dali Nadjib AI Voiture (Single-file generator)</title>
<style>
  :root{
    --bg:#05060a; --card:rgba(255,255,255,0.02); --muted:#9aa4b2;
    --accent1:#ff6b6b; --accent2:#7c5cff; --accent3:#00d4ff; --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box;font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;}
  body{ margin:0; min-height:100vh; background: linear-gradient(180deg,#07101a 0%, #020305 100%); color:#e7f2ff; padding:18px; }
  .wrap{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start; }
  h1{ margin:0 0 10px 0; font-size:20px; display:flex; gap:8px; align-items:center; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03); }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  input[type="text"], textarea, select { width:100%; padding:10px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:inherit; }
  textarea{ min-height:140px; }
  .btn{ padding:10px 12px; border-radius:10px; background:linear-gradient(90deg,var(--accent2),var(--accent3)); color:#04040a; font-weight:800; border:none; cursor:pointer; }
  .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:10px; cursor:pointer; }
  .muted{ color:var(--muted); font-size:13px; }
  .small{ font-size:12px; color:var(--muted); margin-top:8px; }
  .file-row{ display:flex; gap:8px; align-items:center; }
  pre{ background:rgba(0,0,0,0.25); padding:10px; border-radius:8px; color:#dfefff; max-height:220px; overflow:auto; }
  @media (max-width:980px){ .wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <main class="card">
      <h1>مولّد ملف HTML واحد — Dali Nadjib AI Voiture</h1>
      <div class="muted">اتبع الخطوات التالية لإنشاء ملف HTML واحد يحتوي صورتك وقاعدة الأكواد (مضمّنة Base64/JSON).</div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">

      <label>1) رفع صورة البروفايل (تُدمج داخل الملف النهائي)</label>
      <div class="file-row">
        <input id="imgFile" type="file" accept="image/*" />
        <button class="btn-ghost" id="previewImgBtn">معاينة</button>
      </div>
      <div id="imgPreview" style="margin-top:8px;"></div>

      <label style="margin-top:12px">2) رفع ملف الأكواد (codes.json) أو لصق JSON هنا</label>
      <div class="file-row">
        <input id="codesFile" type="file" accept="application/json" />
        <button class="btn-ghost" id="loadSampleBtn">تحميل عيّنة صغيرة (عرض)</button>
      </div>
      <div style="margin-top:8px;">
        <textarea id="codesText" placeholder='يمكنك لصق محتوى ملف JSON هنا (مصفوفة من السجلات: [{"code":"P0300","title":"...","description":"...","causes":["..."],"solutions":["..."]}, ...])'></textarea>
      </div>
      <div class="small">ملف JSON كامل (كل الأكواد) مطلوب لدمج "جميع الأكواد". إن كان لديك ملف خارجي كبير — ارفعه هنا وسيُدمج داخل الملف النهائي.</div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">

      <label>3) إعدادات الملف النهائي</label>
      <label class="small">اسم التطبيق الظاهر في الملف النهائي</label>
      <input id="appName" type="text" value="Dali Nadjib AI Voiture" />

      <label class="small" style="margin-top:8px">توضيح صغير يظهر في الأعلى</label>
      <input id="appTag" type="text" value="واجهة تشخيص OBD بالعربية — ملف واحد شامل" />

      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="btn" id="buildBtn">🛠️ إنشاء ملف HTML كامل (Single-file)</button>
        <button class="btn-ghost" id="downloadCurrentBtn">⬇️ تنزيل النسخة الحالية (مع بيانات الحقل فقط)</button>
      </div>

      <div style="margin-top:12px;">
        <div class="small">ملاحظة: إذا كان ملف الأكواد كبيرًا (ميغابايتات عدة)، إنشاء الملف قد يستغرق بعض الوقت — كل التوليد يحدث محليًا في متصفحك.</div>
      </div>

    </main>

    <aside class="card">
      <h3>معاينة / دلائل</h3>
      <div class="small" style="margin-bottom:8px;">حالة الرفع والمعاينة:</div>
      <div id="statusArea">
        <div class="muted">لم يتم رفع صورة أو ملف أكواد بعد.</div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">

      <h4>تعليمات سريعة</h4>
      <ol class="small">
        <li>ارفع صورتك باستخدام زر "اختيار ملف".</li>
        <li>ارفع ملف `codes.json` الذي يحوي كل الأكواد (إن وجد) أو ألصق JSON في الحقل.</li>
        <li>اضغط "إنشاء ملف HTML كامل" للحصول على ملف واحد قابل للتنزيل.</li>
      </ol>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0;">

      <h4>ملاحظات تقنية</h4>
      <div class="small">
        • كل المعالجة تحدث محليًا في متصفحك — لا شيء يُرسل للخوادم.<br>
        • إن أردت، أستطيع توليد لك ملف JSON كامل بالأكواد (إن رغبّت) — سأحتاج بعض الوقت لذلك ويكون ضمن رد منفصل.
      </div>
    </aside>
  </div>

<script>
/* Helper: read file as text/base64 */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = ()=> rej(new Error('فشل قراءة الملف'));
    r.readAsDataURL(file); // returns data:<mime>;base64,....
  });
}
function fileToText(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = ()=> rej(new Error('فشل قراءة الملف'));
    r.readAsText(file);
  });
}

/* UI elements */
const imgFile = document.getElementById('imgFile');
const codesFile = document.getElementById('codesFile');
const codesText = document.getElementById('codesText');
const previewArea = document.getElementById('imgPreview');
const statusArea = document.getElementById('statusArea');
const buildBtn = document.getElementById('buildBtn');
const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
const previewImgBtn = document.getElementById('previewImgBtn');
const loadSampleBtn = document.getElementById('loadSampleBtn');

let uploadedImageDataUrl = null;
let uploadedCodesJson = null;

/* preview image */
previewImgBtn.addEventListener('click', async ()=>{
  const f = imgFile.files?.[0];
  if(!f) return alert('اختر صورة أولاً');
  try{
    const data = await fileToBase64(f);
    uploadedImageDataUrl = data;
    previewArea.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <img src="${data}" alt="معاينة" style="width:96px;height:96px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)"/>
      <div class="muted">تم تحميل الصورة — سيتم تضمينها في الملف النهائي كـ Base64.</div>
    </div>`;
    statusArea.innerHTML = `<div class="muted">📸 صورة جاهزة للدمج.</div>`;
  }catch(e){ alert('فشل قراءة الصورة'); console.error(e); }
});

/* load sample codes (small) */
loadSampleBtn.addEventListener('click', ()=>{
  // small sample JSON to allow user to try the generator
  const sample = [
    {"code":"P0300","title":"خلل احتراق عشوائي","description":"احتراق غير منتظم...","causes":["شمعات تالفة","كويلات"],"solutions":["تغيير الشمعات","فحص الكويلات"]},
    {"code":"P0420","title":"كفاءة المحول منخفضة","description":"انخفاض أداء المحول الحفاز","causes":["محول تالف","حساسات O2"],"solutions":["فحص المحول","استبدال حساس O2"]}
  ];
  codesText.value = JSON.stringify(sample, null, 2);
  statusArea.innerHTML = `<div class="muted">📄 عيّنة صغيرة أضيفت بالنص. لصق ملف JSON كامل سيحل محله.</div>`;
});

/* upload codes file */
codesFile.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await fileToText(f);
    codesText.value = txt;
    statusArea.innerHTML = `<div class="muted">📄 تم تحميل ملف الأكواد. يمكنك تعديل النص أو المضي لإنشاء الملف.</div>`;
  }catch(err){ alert('فشل قراءة ملف الأكواد'); console.error(err); }
});

/* download helper */
function downloadBlob(filename, content){
  const blob = new Blob([content], {type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* Build single-file HTML */
buildBtn.addEventListener('click', async ()=>{
  const appName = document.getElementById('appName').value || 'Dali Nadjib AI Voiture';
  const appTag = document.getElementById('appTag').value || '';
  // image: if user uploaded but didn't preview, read now
  try{
    if(!uploadedImageDataUrl && imgFile.files?.[0]){
      uploadedImageDataUrl = await fileToBase64(imgFile.files[0]);
    }
  }catch(e){ console.warn('no image'); }

  // codes JSON: from textarea
  const codesRaw = codesText.value && codesText.value.trim();
  if(!codesRaw){
    if(!confirm('لم تضع ملف JSON للأكواد داخل الحقل — استمر وسيُنشأ ملف دون قاعدة أكواد (يمكن استيراد لاحقًا)؟')) return;
  }
  // validate JSON
  let codesObj = null;
  if(codesRaw){
    try{
      codesObj = JSON.parse(codesRaw);
      if(!Array.isArray(codesObj)){
        if(!confirm('محتوى JSON ليس مصفوفة. هل تريد الاستمرار ومحاولة تضمينه كما هو؟')) {
          return;
        }
      }
    }catch(err){
      if(!confirm('الـ JSON غير صالح: ' + err.message + '\nهل تريد المتابعة وضم النص كما هو كنص خام؟')) {
        return;
      }
    }
  }

  statusArea.innerHTML = `<div class="muted">⚙️ جارٍ توليد الملف... (المتصفح المسؤول)</div>`;

  // Build final HTML content (single-file)
  // The final HTML includes: واجهة كاملة شبيهة بالتي قبل + بيانات الأكواد مدمجة كمتغيّر JS (codesData)
  // To avoid extremely long inline, we include codes as a JSON string assigned to a JS variable.
  const imageSnippet = uploadedImageDataUrl ? `<img src="${uploadedImageDataUrl}" alt="logo" style="width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid rgba(0,0,0,0.06)"/>` : '';

  // If codesObj is array, we stringify it safely (escape closing script tag)
  let codesJsonString = '';
  if(codesObj){
    codesJsonString = JSON.stringify(codesObj);
    // escape sequence to prevent </script> in content
    codesJsonString = codesJsonString.replace(/<\/script>/gi, '<\\/script>');
  } else {
    // include empty array placeholder
    codesJsonString = '[]';
  }

  // final HTML template (a simplified but full app)
  const finalHtml = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(appName)} — ملف واحد</title>
<style>
  :root{ --bg:#05060a; --muted:#9aa4b2; --accent2:#7c5cff; --accent3:#00d4ff; --radius:12px; }
  body{ margin:0; min-height:100vh; background:linear-gradient(180deg,#07101a 0%, #020305 100%); color:#e7f2ff; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding:18px; }
  .wrap{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:start; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03); }
  h1{ margin:0; font-size:20px; display:flex; gap:8px; align-items:center; }
  label{ display:block; font-size:13px; color:var(--muted); margin-top:10px; margin-bottom:6px; }
  input[type="text"], select, textarea { width:100%; padding:10px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:inherit; }
  textarea{ min-height:120px; }
  .btn{ padding:10px 12px; border-radius:10px; background:linear-gradient(90deg,var(--accent2),var(--accent3)); color:#04040a; font-weight:800; border:none; cursor:pointer; }
  .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:10px; cursor:pointer; }
  .avatar{ width:72px; height:72px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); }
  .muted{ color:var(--muted); font-size:13px; }
  .resultCard{ padding:14px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02); }
  .fault{ border-radius:10px; padding:12px; margin-bottom:10px; background: linear-gradient(90deg, rgba(124,92,255,0.04), rgba(0,212,255,0.02)); border:1px solid rgba(124,92,255,0.06); }
  pre.analysis{ white-space:pre-wrap; color:#dfeeff; background:rgba(0,0,0,0.18); padding:12px; border-radius:10px; }
  @media (max-width:980px){ .wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <aside class="card" aria-labelledby="title">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
        <div class="avatar">${imageSnippet || '<div style="color:var(--muted);font-weight:800">D N</div>'}</div>
        <div style="flex:1">
          <h1>${escapeHtml(appName)}</h1>
          <div class="muted">${escapeHtml(appTag)}</div>
        </div>
      </div>

      <label>نوع السيارة</label>
      <select id="brand"><option value="all">عام — غير محدد</option><option>Renault</option><option>Peugeot</option><option>Chery</option><option>Fiat</option><option>Hyundai</option><option>Volkswagen</option><option>BMW</option><option>Other</option></select>

      <label>الموديل</label>
      <select id="model"><option>عام — غير محدد</option></select>

      <label>سنة الصنع</label>
      <input id="year" type="text" placeholder="مثال: 2015" />

      <label>كود OBD (اكتب أو اختر)</label>
      <div style="display:flex;gap:8px;">
        <input id="codeInput" type="text" placeholder="P0300" />
        <button class="btn-ghost" id="openList">قائمة الأكواد</button>
      </div>

      <label>وصف حالة السيارة</label>
      <textarea id="desc" placeholder="مثال: المحرك يهتز عند التشغيل..."></textarea>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" id="analyzeBtn">🔎 تشخيص الآن</button>
        <button class="btn-ghost" id="resetBtn">♻️ مسح</button>
      </div>
    </aside>

    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>نتائج التشخيص</strong><div class="muted" id="meta">لم يتم إجراء تشخيص بعد</div></div>
        <div><button class="btn-ghost" id="copyBtn">📋 نسخ</button></div>
      </div>
      <div id="output" class="resultCard" style="margin-top:12px;">
        <div class="muted">اضغط "تشخيص الآن" لبدء التحليل.</div>
      </div>
    </main>
  </div>

<script>
/* البيانات المضمّنة */
const CODES_DB = ${codesJsonString};

/* نماذج الموديلات (مبسطة) */
const MODELS = {
  "Renault":["Clio","Symbol","Megane","Kangoo","Captur"],
  "Peugeot":["206","207","208","301","308"],
  "Chery":["Tiggo 3","Tiggo 7"],
  "Fiat":["Punto","500"],
  "Hyundai":["Accent","i10","i20","Elantra"],
  "Volkswagen":["Golf","Polo"],
  "BMW":["3 Series","5 Series"],
  "Other":["موديل آخر"],
  "all":["عام — غير محدد"]
};

function fillModelsFor(brand){
  const sel = document.getElementById('model');
  sel.innerHTML='';
  (MODELS[brand]||MODELS['Other']).forEach(m=>{
    const o = document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o);
  });
}
fillModelsFor('all');
document.getElementById('brand').addEventListener('change', e => fillModelsFor(e.target.value));

/* show code selector modal */
document.getElementById('openList').addEventListener('click', ()=>{
  const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.background='rgba(0,0,0,0.6)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=9999;
  const box = document.createElement('div'); box.style.width='80%'; box.style.maxHeight='80vh'; box.style.overflow='auto'; box.style.background='linear-gradient(180deg,#08101a,#061018)'; box.style.padding='12px'; box.style.borderRadius='10px';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const h = document.createElement('strong'); h.textContent='قائمة الأكواد — اختر كودًا';
  const close = document.createElement('button'); close.className='btn-ghost'; close.textContent='إغلاق'; close.addEventListener('click', ()=> overlay.remove());
  header.appendChild(h); header.appendChild(close); box.appendChild(header);
  const search = document.createElement('input'); search.placeholder='ابحث بالكود أو بالكلمة'; search.style.width='100%'; search.style.margin='10px 0'; search.style.padding='8px'; box.appendChild(search);
  const list = document.createElement('div'); box.appendChild(list);

  function render(q=''){
    list.innerHTML=''; const qq=(q||'').toLowerCase().trim();
    const items = CODES_DB.filter(it => {
      if(!qq) return true;
      return ((it.code||'') + ' ' + (it.title||'') + ' ' + (it.description||'') + ' ' + (it.causes||[]).join(' ')).toLowerCase().includes(qq);
    });
    items.slice(0,1000).forEach(it=>{
      const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)'; row.style.cursor='pointer';
      row.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>'+escapeHtml(it.code||'')+'</strong> <span style="color:var(--muted);margin-left:8px">'+escapeHtml(it.title||'')+'</span></div><div style="color:var(--muted)">'+(it.brands?it.brands.join(' · '):'عام')+'</div></div>';
      row.addEventListener('click', ()=>{ document.getElementById('codeInput').value = it.code || ''; overlay.remove(); });
      list.appendChild(row);
    });
    if(items.length===0) list.innerHTML='<div class="muted">لا توجد نتائج</div>';
  }
  render();
  search.addEventListener('input', (e)=> render(e.target.value));
  overlay.appendChild(box); document.body.appendChild(overlay);
});

/* search helpers */
function findByCode(code){
  if(!code) return null;
  const c = code.toString().trim().toUpperCase();
  return CODES_DB.filter(it => (it.code||'').toString().toUpperCase() === c);
}
function keywordMatch(text){
  if(!text) return [];
  const tokens = text.toLowerCase().split(/\\s+/).filter(t=>t.length>2);
  if(tokens.length===0) return [];
  return CODES_DB.filter(item=>{
    const hay = (item.title||'') + ' ' + (item.description||'') + ' ' + (item.causes||[]).join(' ') + ' ' + (item.solutions||[]).join(' ');
    const low = hay.toLowerCase();
    return tokens.some(tok => low.includes(tok));
  });
}

document.getElementById('analyzeBtn').addEventListener('click', ()=>{
  const brand = document.getElementById('brand').value || 'all';
  const model = document.getElementById('model').value || '';
  const year = document.getElementById('year').value || '';
  const code = (document.getElementById('codeInput').value || '').trim().toUpperCase();
  const desc = (document.getElementById('desc').value || '').trim();
  const out = document.getElementById('output'); out.innerHTML=''; document.getElementById('meta').textContent = 'ماركة: ' + brand + ' · موديل: ' + (model||'—') + ' · سنة: ' + (year||'—') + ' · كود: ' + (code||'—');

  let results = [];
  if(code){
    const byCode = findByCode(code);
    if(byCode.length) results = results.concat(byCode);
    else {
      // prefix match
      const alt = CODES_DB.filter(it => ((it.code||'')+'').toUpperCase().includes(code.replace(/[^A-Z0-9]/g,'')));
      results = results.concat(alt);
    }
  }
  if(desc){
    const matched = keywordMatch(desc);
    matched.forEach(m=>{ if(!results.some(r=>r.code===m.code)) results.push(m); });
  }
  if(results.length===0){
    // fallback: try search code or desc as substring
    const q = (code || desc).toLowerCase();
    if(q){
      const simple = CODES_DB.filter(it => (((it.code||'') + ' ' + (it.title||'') + ' ' + (it.description||'')).toLowerCase().includes(q)));
      simple.forEach(m=>{ if(!results.some(r=>r.code===m.code)) results.push(m); });
    }
  }

  if(results.length===0){
    out.innerHTML = '<div class="muted">لم نعثر على نتائج — جرّب تغيّر المدخلات أو استيراد JSON أكبر.</div>';
    return;
  }

  results.forEach(item=>{
    const el = document.createElement('div'); el.className='fault';
    el.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="color:var(--muted);font-size:13px">الكود</div><div style="font-size:18px;font-weight:800">'+escapeHtml(item.code||'')+'</div></div><div style="text-align:left"><div style="font-size:13px;color:var(--muted)">'+((item.brands && item.brands.length)? item.brands.join(' · ') : 'عام')+'</div><div style="font-weight:800;margin-top:6px">'+escapeHtml(item.title||'')+'</div></div></div><div style="margin-top:10px;color:var(--muted)">'+escapeHtml(item.description||'')+'</div><div style="margin-top:10px"><strong>الأسباب المحتملة:</strong><ul>' + ((item.causes||[]).map(c=>'<li>'+escapeHtml(c)+'</li>').join('')) + '</ul></div><div style="margin-top:6px"><strong>الحلول الممكنة:</strong><ul>' + ((item.solutions||[]).map(s=>'<li>'+escapeHtml(s)+'</li>').join('')) + '</ul></div>';
    out.appendChild(el);
  });

  // analysis
  const systems = Array.from(new Set(results.map(r=>r.system))).join(' · ');
  const codesList = Array.from(new Set(results.map(r=>r.code))).join(', ');
  const analysis = 'تحليل عام: بناءً على المدخلات (ماركة: ' + brand + ', موديل: ' + (model||'غير محدد') + ', سنة: ' + (year||'غير محددة') + ') والأكواد/الوصف (' + codesList + ')، المرجح أن تكون المشاكل مرتبطة بالأنظمة: ' + systems + '.\\n\\nالتحقّق الموصى به:\\n1) فحص الوصلات، الفيوزات، مأخذ OBD.\\n2) فحص الشمعات والكويلات والماف والبخاخات.\\n3) مراقبة Live data إن أمكن قبل الاستبدال.\\n\\nملاحظة: توصيات مبدئية — قد يلزم فحص متقدّم لدى فني.';

  const analysisEl = document.createElement('div'); analysisEl.style.marginTop='12px';
  analysisEl.innerHTML = '<h4 style="margin:0 0 8px 0;">🔎 تحليل مفصّل (بالعربية)</h4><pre class="analysis">'+escapeHtml(analysis)+'</pre>';
  out.appendChild(analysisEl);
});

/* copy */
document.getElementById('copyBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('output').innerText;
  navigator.clipboard?.writeText(txt).then(()=> alert('تم نسخ النص ✅')).catch(()=> alert('فشل النسخ — جرب متصفح أحدث'));
});

/* reset */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('brand').value = 'all';
  fillModelsFor('all');
  document.getElementById('year').value = '';
  document.getElementById('codeInput').value = '';
  document.getElementById('desc').value = '';
  document.getElementById('output').innerHTML = '<div class="muted">اضغط "تشخيص الآن" لبدء التحليل.</div>';
});

/* helper escape */
function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }

/* final note: ready */
</script>
</body>
</html>
`;

  // download file
  downloadBlob('dali_nadjib_ai_voiture_full.html', finalHtml);
  statusArea.innerHTML = `<div class="muted">✅ تم إنشاء الملف. سيتم تنزيله تلقائيًا (أو تحقق من التنزيل في متصفحك).</div>`;
});

/* download current simple template (without codes) */
downloadCurrentBtn.addEventListener('click', ()=>{
  const appName = document.getElementById('appName').value || 'Dali Nadjib AI Voiture';
  const appTag = document.getElementById('appTag').value || '';
  const sample = '<!doctype html><html><head><meta charset="utf-8"><title>Sample</title></head><body><h1>'+escapeHtml(appName)+'</h1><p>'+escapeHtml(appTag)+'</p></body></html>';
  downloadBlob('dali_nadjib_ai_voiture_sample.html', sample);
  statusArea.innerHTML = '<div class="muted">تم تنزيل نسخة بسيطة.</div>';
});

/* escape helper (used above) */
function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
</script>
</body>
</html>
