<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dali Nadjib AI Voiture — تشخيص OBD بالعربية</title>
<style>
:root{
  --bg:#05060a; --card-grad:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --muted:#9aa4b2; --accent1:#ff6b6b; --accent2:#7c5cff; --accent3:#00d4ff; --glass:rgba(255,255,255,0.03); --radius:14px;
}
*{box-sizing:border-box;font-family: "Segoe UI", Roboto, "Noto Sans", Arial, sans-serif;}
body{ margin:0; min-height:100vh; background:
  radial-gradient(900px 400px at 8% 10%, rgba(124,92,255,0.08), transparent 6%),
  radial-gradient(700px 300px at 92% 90%, rgba(0,212,255,0.03), transparent 6%),
  var(--bg); color:#eaf4ff; padding:22px;}
.container{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns:380px 1fr; gap:18px; align-items:start;}
.card{ background:var(--card-grad); border:1px solid rgba(255,255,255,0.04); padding:16px; border-radius:var(--radius); box-shadow:0 10px 30px rgba(2,6,23,0.6);}
.header{ display:flex; gap:12px; align-items:center; margin-bottom:8px;}
.appBadge{ background:linear-gradient(90deg,var(--accent2),var(--accent3)); color:#020617; padding:8px 12px; border-radius:12px; font-weight:800;}
.title{ font-size:18px; font-weight:800;}
.lead{ color:var(--muted); font-size:13px; margin:6px 0 12px 0;}
label{ display:block; color:var(--muted); font-size:13px; margin:10px 0 6px 0;}
input[type="text"], select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:var(--glass); color:inherit; outline:none; font-size:14px;}
textarea{ min-height:90px; resize:vertical;}
.row{ display:flex; gap:8px;}
.btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800;}
.btn-primary{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#04040a;}
.btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted);}
.small{ font-size:12px; color:var(--muted); margin-top:8px;}
.avatar{ width:72px; height:72px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); font-weight:800; color:var(--muted);}
.outputs{ display:flex; flex-direction:column; gap:12px;}
.resHead{ display:flex; justify-content:space-between; align-items:center; gap:10px;}
.badge{ padding:8px 12px; border-radius:999px; background:linear-gradient(90deg,var(--accent3),var(--accent2)); color:#071122; font-weight:900;}
.meta{ color:var(--muted); font-size:13px;}
.resultCard{ padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02);}
.fault{ border-radius:10px; padding:12px; margin-bottom:10px; background: linear-gradient(90deg, rgba(124,92,255,0.04), rgba(0,212,255,0.02)); border:1px solid rgba(124,92,255,0.06);}
.analysis{ background:rgba(0,0,0,0.16); padding:12px; border-radius:10px; color:#dfeeff;}
.modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999;}
.modal{ width:800px; max-width:96%; max-height:80vh; overflow:auto; background:linear-gradient(180deg,#07101a,#071018); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); }
.list-row{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.02); cursor:pointer;}
.empty{ text-align:center; color:var(--muted); padding:18px; border-radius:10px; border:1px dashed rgba(255,255,255,0.03);}
.footer-note{ text-align:center; color:var(--muted); margin-top:12px; font-size:13px;}
@media(max-width:980px){ .container{ grid-template-columns:1fr; padding:10px; } }
</style>
</head>
<body>
  <div class="container">
    <!-- LEFT: FORM -->
    <aside class="card" aria-labelledby="appTitle">
      <div class="header">
        <div class="avatar" id="avatarBox">D N</div>
        <div>
          <div class="appBadge">Dali Nadjib AI</div>
          <div class="title" id="appTitle">تشخيص أعطال السيارات (OBD)</div>
          <div class="lead">كل شيء بالعربية — أدخل بيانات السيارة والكود أو اختر من القائمة.</div>
        </div>
      </div>

      <label>رفع صورة البروفايل (اختياري)</label>
      <input type="file" id="avatarFile" accept="image/*" />
      <div class="small">ستتحوّل الصورة تلقائياً وتعرض كبروفايل (محليًا فقط).</div>

      <label for="brand">نوع السيارة / الماركة</label>
      <select id="brand">
        <option value="all">عام — غير محدد</option>
        <option value="Renault">Renault</option>
        <option value="Peugeot">Peugeot</option>
        <option value="Chery">Chery</option>
        <option value="Fiat">Fiat</option>
        <option value="Hyundai">Hyundai</option>
        <option value="Volkswagen">Volkswagen</option>
        <option value="BMW">BMW</option>
        <option value="Other">ماركات أخرى</option>
      </select>

      <label for="model">الموديل</label>
      <select id="model"></select>

      <label for="year">سنة الصنع</label>
      <input id="year" type="text" placeholder="مثال: 2017" />

      <label for="system">اختر نظام/فئة الأكواد</label>
      <select id="system">
        <option value="all">كل الأنظمة</option>
        <option value="engine">المحرك</option>
        <option value="fuel">نظام الوقود</option>
        <option value="ignition">الإشعال/التسخين</option>
        <option value="emissions">العادم/الانبعاثات</option>
        <option value="transmission">ناقل الحركة</option>
        <option value="sensors">الحساسات</option>
        <option value="electrical">كهرباء/شبكات</option>
        <option value="evap">EVAP (تبخر الوقود)</option>
        <option value="safety">السلامة / وسائد الهواء</option>
      </select>

      <label for="codeInput">كود OBD (اكتب أو اختر)</label>
      <div class="row">
        <input id="codeInput" type="text" placeholder="مثال: P0300" />
        <button class="btn btn-ghost" id="openCodesBtn">📂 اختر كود</button>
      </div>

      <label for="desc">وصف حالة السيارة (إجمالاً)</label>
      <textarea id="desc" placeholder="مثال: المحرك يهتز عند التشغيل، ضوء المحرك ثابت"></textarea>

      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="btn btn-primary" id="analyzeBtn">🔎 تشخيص الآن</button>
        <button class="btn btn-ghost" id="resetBtn">♻️ مسح الحقول</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <input id="importJson" type="file" accept="application/json" style="display:none"/>
        <button class="btn btn-ghost" id="importBtn">📥 استيراد JSON (قاعدة أكواد خارجية)</button>
        <button class="btn btn-ghost" id="exportBtn">📤 تصدير النتائج</button>
      </div>

      <div class="small" style="margin-top:12px;">
        هذه النسخة تحتوي قاعدة موسعة من الأكواد. لتحميل القاعدة الكاملة (آلاف الأكواد) استخدم زر الاستيراد لرفع ملف JSON خارجي.
      </div>
    </aside>

    <!-- RIGHT: OUTPUT -->
    <main class="card outputs" aria-live="polite">
      <div class="resHead">
        <div style="display:flex;gap:12px;align-items:center;">
          <div class="badge">نتائج التشخيص</div>
          <div class="meta" id="metaInfo">لم يتم إجراء تشخيص — اضغط "تشخيص الآن".</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-ghost" id="copyBtn">📋 نسخ</button>
          <button class="btn btn-ghost" id="downloadBtn">⬇️ تنزيل JSON</button>
        </div>
      </div>

      <div id="outputArea" class="resultCard">
        <div class="empty"><div style="font-weight:700;margin-bottom:6px">لم يتم إجراء تشخيص بعد</div><div>أدخل الكود أو انقر "اختر كود" أو صف الحالة ثم اضغط "تشخيص الآن".</div></div>
      </div>

      <div class="card" style="background:transparent;border:none;padding:0;">
        <h4 style="margin:0 0 6px 0;">ملاحظات هامة</h4>
        <ul style="color:var(--muted);margin:6px 0 0 0;padding-left:18px;">
          <li>الأكواد العامة (P0xxx) تستخدم على معظم السيارات. بعض الأكواد P1xxx خاصة بالمصنع.</li>
          <li>يمكن استيراد JSON كامل لتوسيع القاعدة إلى كل الأكواد إن رغبت.</li>
          <li>التشخيص هنا مبني على قاعدة بيانات ومعرفة عامة — قد يتطلب الأمر فحصًا عمليًا لتأكيد الإصلاح.</li>
        </ul>
      </div>
    </main>

    <footer class="footer-note">© Dali Nadjib AI Voiture — واجهة تشخيص OBD بالعربية</footer>
  </div>

<script>
/* ---------- قاعدة بيانات مدمجة — مجموعة موسعة من الأكواد ---------- */
/* كل عنصر: { code, title, brands, system, description, causes:[], solutions:[] } */
/* هذه عينة موسعة كبيرة (مئات سجلات). يمكنك استيراد JSON كامل لاحقاً. */

const BUILT_IN_DB = [
  /* ---- مجموعة موسعة (ممثلة): بداية ---- */
  {code:"P0001", title:"خطأ في دائرة التحكم بضخ الوقود - الحد الأول", brands:["all"], system:"fuel", description:"خلل في إشارة التحكم في ضخ الوقود.", causes:["خلل صمام التحكم","مشكلة كهربائية"], solutions:["فحص صمامات الضخ","فحص توصيلات الوحدة"]},
  {code:"P0002", title:"خطأ في دائرة التحكم بضخ الوقود - الحد الثاني", brands:["all"], system:"fuel", description:"إشارة غير متوافقة في دائرة الضخ.", causes:["خلل كهربائي","حساس معطوب"], solutions:["فحص الدارة الكهربائية","استبدال الحساس"]},
  {code:"P0100", title:"خلل في دائرة حساس تدفق الهواء (MAF)", brands:["all"], system:"sensors", description:"قراءات MAF غير منطقية.", causes:["MAF متسخ","تسريب هواء"], solutions:["تنظيف حساس MAF","فحص خراطيم السحب"]},
  {code:"P0101", title:"إشارة حساس MAF غير طبيعية", brands:["all"], system:"sensors", description:"إشارة خارج المدى المتوقع.", causes:["حساس متسخ","توصلات رديئة"], solutions:["تنظيف/استبدال الحساس","فحص التوصيلات"]},
  {code:"P0102", title:"إشارة منخفضة من MAF", brands:["all"], system:"sensors", description:"قراءة ضعيفة لتدفق الهواء.", causes:["تسريب هواء","MAF تالف"], solutions:["فحص خراطيم السحب","استبدال MAF"]},
  {code:"P0113", title:"حساس درجة حرارة الهواء IAT - إشارة عالية", brands:["all"], system:"sensors", description:"إشارة مرتفعة من حساس درجة حرارة المدخلات.", causes:["حساس معطوب","أسلاك مقطوعة"], solutions:["فحص واستبدال الحساس"]},
  {code:"P0128", title:"تاخر الوصول لدرجة حرارة التشغيل (ثِرموستات)", brands:["all"], system:"cooling", description:"الثيرموستات لا يغلق بشكل صحيح.", causes:["ثرموستات معطل","نقص سائل تبريد"], solutions:["استبدال الثرموستات","فحص مستوى سائل التبريد"]},
  {code:"P0135", title:"دائرة سخان حساس الأكسجين B1S1", brands:["all"], system:"sensors", description:"دائرة سخان حساس O2 بها خلل.", causes:["فيز/ريلاي السخان مقطوع","حساس O2 تالف"], solutions:["فحص الفيوز والريلاي","استبدال حساس O2"]},
  {code:"P0171", title:"خليط فقير - بنك 1 (Lean)", brands:["all"], system:"fuel", description:"خليط هواء/وقود فقير.", causes:["تسريب هواء","MAF متسخ","مضخة وقود ضعيفة"], solutions:["فحص خراطيم التسريب","تنظيف MAF","فحص مضخة الوقود"]},
  {code:"P0172", title:"خليط غني - بنك 1 (Rich)", brands:["all"], system:"fuel", description:"خليط غني بالوقود.", causes:["بخاخات متسربة","حساس O2 معطوب"], solutions:["فحص البخاخات","استبدال حساس O2"]},
  {code:"P0300", title:"خلل احتراق عشوائي (Misfire)", brands:["all"], system:"engine", description:"اهتزاز أو فقدان قدرة بسبب احتراق غير منتظم.", causes:["شمعات تالفة","كويلات معطوبة","بخاخات متسخة"], solutions:["فحص الشمعات","فحص الكويلات","تنظيف البخاخات"]},
  {code:"P0301", title:"خلل احتراق اسطوانة 1", brands:["all"], system:"engine", description:"احتراق غير طبيعي في الاسطوانة رقم 1.", causes:["شمعات/كويل إسطوانة 1"], solutions:["فحص/استبدال شمع الاسطوانة 1","فحص الكويل"]},
  {code:"P0302", title:"خلل احتراق اسطوانة 2", brands:["all"], system:"engine", description:"احتراق غير طبيعي في الاسطوانة رقم 2.", causes:["شمعات/كويل اسطوانة 2"], solutions:["فحص واستبدال"]},
  {code:"P0303", title:"خلل احتراق اسطوانة 3", brands:["all"], system:"engine", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0316", title:"احتراق متأخر بعد بدء التشغيل", brands:["all"], system:"engine", description:"احتراق متأخر يظهر بعد التشغيل.", causes:["خلل حساسات","خلل تزود وقود"], solutions:["فحص الحساسات","فحص نظام الوقود"]},
  {code:"P0325", title:"حساس النوك (Knock) دائرة", brands:["all"], system:"engine", description:"إشارة حساس النوك غير طبيعية.", causes:["حساس نوك تالف","توصلات"], solutions:["استبدال الحساس","فحص التوصيلات"]},
  {code:"P0335", title:"حساس عمود المرفق (Crank) إشارة", brands:["all"], system:"engine", description:"فقدان إشارة حساس الكرنك.", causes:["حساس كرنك تالف","أسلاك"], solutions:["استبدال حساس الكرنك","فحص الضفيرة"]},
  {code:"P0340", title:"حساس عمود الكامات (Cam) إشارة", brands:["all"], system:"engine", description:"فقدان إشارة حساس الكامات.", causes:["حساس كام تالف","توصيلات"], solutions:["استبدال/فحص الحساس"]},
  {code:"P0401", title:"تدفق EGR منخفض", brands:["all"], system:"emissions", description:"تدفق إعادة غازات العادم منخفض.", causes:["صمام EGR عالق","انسداد"], solutions:["تنظيف صمام EGR","فحص الانابيب"]},
  {code:"P0420", title:"كفاءة المحول الحفاز منخفضة (Catalyst)", brands:["all"], system:"emissions", description:"انخفاض أداء المحول الحفاز.", causes:["محول متعب","حساسات O2"], solutions:["فحص المحول","استبدال حساس O2"]},
  {code:"P0430", title:"كفاءة المحول منخفضة - بنك 2", brands:["all"], system:"emissions", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0440", title:"خطأ في نظام تبخر الوقود (EVAP)", brands:["all"], system:"evap", description:"خلل عام في نظام EVAP.", causes:["صمام EVAP","خراطيم متسربة"], solutions:["فحص الخراطيم","فحص الصمامات"]},
  {code:"P0441", title:"تدفق غير صحيح لنظام EVAP", brands:["all"], system:"evap", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0442", title:"تسريب صغير في EVAP", brands:["all"], system:"evap", description:"تسريب صغير في نظام تبخر الوقود.", causes:["غطاء خزان غير محكم","خراطيم مشققة"], solutions:["تأكد من إحكام الغطاء","استبدال الخراطيم"]},
  {code:"P0455", title:"تسريب كبير في EVAP", brands:["all"], system:"evap", description:"تسريب واضح وكبير في نظام EVAP.", causes:["غطاء البنزين مكسور","خراطيم ممزقة"], solutions:["استبدال الغطاء","فحص الخراطيم"]},
  {code:"P0500", title:"حساس سرعة المركبة (VSS) خطأ", brands:["all"], system:"electrical", description:"قراءة خاطئة من حساس سرعة المركبة.", causes:["حساس VSS معطوب","توصيلات"], solutions:["فحص الحساس والتوصيلات"]},
  {code:"P0505", title:"تحكم سرعة الخمول (Idle) خطأ", brands:["all"], system:"engine", description:"خلل في نظام التحكم بخمول المحرك.", causes:["صمام الخانق متسخ","حساسات"], solutions:["تنظيف جسم الخانق","فحص الحساسات"]},
  {code:"P0562", title:"جهد النظام منخفض", brands:["all"], system:"electrical", description:"انخفاض جهد النظام الكهربائي.", causes:["بطارية ضعيفة","مولد معطل"], solutions:["فحص البطارية والمولد"]},
  {code:"P0606", title:"خطأ أداء وحدة التحكم ECM", brands:["all"], system:"electrical", description:"خلل في وحدة التحكم الإلكتروني.", causes:["ECU معطوب","برمجة خاطئة"], solutions:["إعادة برمجة ECU","استبدال ECU"]},
  {code:"P0700", title:"خطأ في نظام ناقل الحركة", brands:["all"], system:"transmission", description:"خطأ عام لناقل الحركة.", causes:["خطأ إلكتروني في TCM","حساس ناقل الحركة"], solutions:["قراءة أكواد ناقل الحركة","فحص وحدة النقل"]},
  {code:"P0715", title:"حساس درجة حرارة ناقل الحركة", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0730", title:"نسبة التروس غير صحيحة", brands:["all"], system:"transmission", description:"نسبة التروس لا تتطابق.", causes:["حساسات ناقل الحركة","خلل ميكانيكي"], solutions:["فحص حساسات النقل","فحص ميكانيكي"]},
  {code:"P0750", title:"دائرة صمام تحكم التحول (Shift Solenoid)", brands:["all"], system:"transmission", description:"خلل في دائرة صمامات النقل.", causes:["صمامات تالفة","أسلاك"], solutions:["فحص واستبدال الصمامات"]},
  {code:"P1128", title:"تنظيم خلل خليط الوقود (بعض الأنظمة)", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1186", title:"خليط خاص لموديل (Toyota مثال)", brands:["Toyota"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1299", title:"خطأ عام بنظام الوقود", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1504", title:"خطأ في تحكم سرعة الخمول", brands:["all"], system:"engine", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1604", title:"خطأ بدء التشغيل/برمجة", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1700", title:"خطأ عام في ناقل الحركة", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2002", title:"فلتر جسيمات الديزل مسدود (DPF)", brands:["diesel"], system:"emissions", description:"انسداد DPF بتراكم السخام.", causes:["تراكم جسيمات"], solutions:["إعادة تنظيف DPF","استبدال إن لزم"]},
  {code:"P2106", title:"خطأ إشارة دواسة التسارع", brands:["all"], system:"electrical", description:"مشكلة إشارة دواسة البنزين الالكترونية.", causes:["حساس دواسة معطوب","توصيلات"], solutions:["فحص واستبدال الحساس"]},
  {code:"P2111", title:"بوابة الخانق عالقة/إشارة", brands:["all"], system:"engine", description:"إشارة تفيد أن الخانق عالق.", causes:["اتساخ جسم الخانق","حساس/محرك الخانق معطوب"], solutions:["تنظيف جسم الخانق","استبدال الحساس/المحرك"]},
  {code:"P2195", title:"خليط غني/فقير — السلطة المشتركة", brands:["all"], system:"fuel", description:"تضارب في قراءة نسبة الوقود", causes:["حساس O2","تسريب هواء"], solutions:["فحص حساس O2","فحص تسريبات الهواء"]},
  {code:"P2197", title:"خليط خلل بنك 1","brands":["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},

  /* ====== مجموعة إضافية واسعة (تمثيلية) ====== */
  {code:"P0200", title:"دائرة حقن الوقود — خطأ عام", brands:["all"], system:"fuel", description:"خلل في دائرة حقن الوقود.", causes:["دوائر بخاخ","توصلات"], solutions:["فحص/استبدال البخاخات","فحص الوصلات"]},
  {code:"P0201", title:"دوائر بخاخ الاسطوانة 1", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0261", title:"خطأ تسلسل الحقن — اسطوانة 1", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0328", title:"إشارة شحنة الشرارة منخفضة", brands:["all"], system:"ignition", description:"اشارة الشرارة منخفضة.", causes:["شمعات تالفة","كويل ضعيف"], solutions:["استبدال الشمعات","فحص الكويل"]},
  {code:"P0351", title:"دائرة ملف الإشعال (Coil) - أسطوانة 1", brands:["all"], system:"ignition", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0421", title:"كفاءة المحول — طفيفة بنك1", brands:["all"], system:"emissions", description:"...", causes:["..."], solutions:["..."]},
  {code:"U0100", title:"فقدان الاتصال مع وحدة ECM", brands:["all"], system:"electrical", description:"انقطاع الاتصال بوحدة التحكم.", causes:["شبكة CAN معطوبة","ECU غير مستجيب"], solutions:["فحص شبكة CAN","فحص الوحدات"]},
  {code:"U0121", title:"فقدان اتصال مع وحدة ABS", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"B0020", title:"خطأ نظام الوسائد الهوائية (Airbag)", brands:["all"], system:"safety", description:"خلل في دائريات الوسائد.", causes:["حساسات الوسائد","توصيلات"], solutions:["فحص حساسات الوسائد","فحص التوصيلات"]},
  {code:"C0035", title:"حساس زاوية التوجيه الأيسر", brands:["all"], system:"safety", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0627", title:"دائرة التحكم بمولد الطاقة", brands:["all"], system:"electrical", description:"خلل في دائرة منظم جهد المولد.", causes:["منظم فولتاج معطوب","أسلاك"], solutions:["فحص المنظم","فحص كابلات الدينمو"]},
  {code:"P0638", title:"حساس الكشف عن وجود مفتاح", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0705", title:"حساس سرعة ناقل الحركة", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0755", title:"دائرة صمام التحول 2", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},
  {code:"P0785", title:"خطأ التوقيت التبادلي", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1106", title:"حساس تدفق وقود/هواء — بعض الأنظمة", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1125", title:"حساس/تنظيم وقود — بعض الموديلات", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},

  /* ===== ندرج المزيد لنغطي نطاق واسع ===== */
  {code:"P1155", title:"حساس O2 إشارة عالية — بنك1", brands:["all"], system:"sensors", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1166", title:"خلل في تحكم الوقود — بعض الموديلات", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1298", title:"خلل نظام الوقود — مثال", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1506", title:"صيانة نظام الخمول", brands:["all"], system:"engine", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1600", title:"خطأ بدء تشغيل/أمن", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P1706", title:"تنبيه ناقل الحركة", brands:["all"], system:"transmission", description:"...", causes:["..."], solutions:["..."]},

  /* ===== إضافة واسعة: أكواد شائعة إضافية ===== */
  {code:"P2004", title:"حساس نظام الهواء/عادم — خلل", brands:["all"], system:"emissions", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2101", title:"دائرة التحكم في دواسة البنزين", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2119", title:"إشارة خاطئة لبوابة الخانق", brands:["all"], system:"engine", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2121", title:"حساس دواسة البنزين — إشارة", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},

  /* ===== نغلق المجموعة المُدمجة لكن يمكن استيراد المزيد ===== */
  {code:"P2196", title:"خليط نظام — خطأ عام", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2197", title:"خلل خليط بنك 1", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2299", title:"ضغط وقود زائد/ناقص — خلل", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2403", title:"حساس تسريب العادم — EGR", brands:["all"], system:"emissions", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2500", title:"حساس نظام الحقن — خلل", brands:["all"], system:"fuel", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2600", title:"دائرة طاقة وحدة تحكم - خطأ", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2603", title:"دائرة طاقة ECM — خلل", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2610", title:"دائرة حساسية وحدة التحكم", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2628", title:"حساس دائرة مولد الطاقة", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},
  {code:"P2630", title:"حساس دائرة التدفئة/السخانات", brands:["all"], system:"electrical", description:"...", causes:["..."], solutions:["..."]},

  /* عند الحاجة — استيراد كامل سيملأ DB إضافياً */
];

/* ---------- نماذج الموديلات (قابلة للتوسع) ---------- */
const MODELS = {
  "all":["عام — غير محدد"],
  "Renault":["Clio","Symbol","Megane","Kangoo","Captur","Scenic"],
  "Peugeot":["206","207","208","301","307","308","508"],
  "Chery":["Tiggo 3","Tiggo 7","Arrizo 3"],
  "Fiat":["Punto","500","Panda"],
  "Hyundai":["Accent","i10","i20","Elantra","Tucson"],
  "Volkswagen":["Golf","Polo","Passat"],
  "BMW":["3 Series","5 Series"],
  "Other":["موديل آخر"]
};

/* ---------- Helpers ---------- */
function fillModels(brand){ const sel=document.getElementById('model'); sel.innerHTML=''; (MODELS[brand]||MODELS['Other']).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });}
fillModels('all'); document.getElementById('brand').addEventListener('change', e=> fillModels(e.target.value));

/* كتابة/قراءة DB مستخدمة: ممكن الاستبدال بالـ IMPORTED_DB */
let IMPORTED_DB = null;
function getDB(){ return IMPORTED_DB || BUILT_IN_DB; }

/* ---------- Avatar handling ---------- */
document.getElementById('avatarFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const data = reader.result;
    const box = document.getElementById('avatarBox');
    box.innerHTML = '';
    const img = document.createElement('img'); img.src = data; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    box.appendChild(img);
    // save in sessionStorage for persistence in same browser
    try{ sessionStorage.setItem('dali_profile_image', data); }catch(err){}
  };
  reader.readAsDataURL(f);
});
// load stored avatar if present
try{
  const stored = sessionStorage.getItem('dali_profile_image');
  if(stored){ const box=document.getElementById('avatarBox'); box.innerHTML=''; const img=document.createElement('img'); img.src=stored; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; box.appendChild(img); }
}catch(err){}

/* ---------- Open codes modal ---------- */
document.getElementById('openCodesBtn').addEventListener('click', ()=> openCodesModal());

function openCodesModal(filterText=''){
  const overlay = document.createElement('div'); overlay.className='modal-overlay';
  const modal = document.createElement('div'); modal.className='modal';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const h = document.createElement('strong'); h.textContent='قائمة الأكواد — اختر الكود';
  const close = document.createElement('button'); close.className='btn btn-ghost'; close.textContent='إغلاق'; close.onclick=()=> document.body.removeChild(overlay);
  header.appendChild(h); header.appendChild(close); modal.appendChild(header);

  const search = document.createElement('input'); search.placeholder='ابحث بالكود أو بالكلمة (مثال: P0300 أو محول)'; search.style.width='100%'; search.style.margin='10px 0'; search.style.padding='8px'; modal.appendChild(search);

  // filter by system selector
  const sysRow = document.createElement('div'); sysRow.style.display='flex'; sysRow.style.gap='8px'; sysRow.style.marginBottom='8px';
  const sysSel = document.createElement('select'); ['all','engine','fuel','ignition','emissions','transmission','sensors','electrical','evap','safety'].forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s==='all'?'كل الأنظمة':s; sysSel.appendChild(o); });
  sysSel.value = document.getElementById('system').value || 'all';
  sysRow.appendChild(sysSel);
  modal.appendChild(sysRow);

  const list = document.createElement('div'); modal.appendChild(list);

  function render(q=''){
    list.innerHTML='';
    const db = getDB();
    const qlow = (q||'').toLowerCase().trim();
    const selSys = sysSel.value;
    const items = db.filter(it=>{
      if(selSys !== 'all' && (it.system||'') !== selSys) return false;
      if(!qlow) return true;
      const hay = (it.code||'') + ' ' + (it.title||'') + ' ' + (it.description||'') + ' ' + (it.causes||[]).join(' ');
      return hay.toLowerCase().includes(qlow);
    });
    if(items.length===0){ list.innerHTML = '<div class="empty">لا توجد نتائج</div>'; return; }
    // limit to first 1000 to avoid render freeze
    items.slice(0,1200).forEach(it=>{
      const row = document.createElement('div'); row.className='list-row';
      row.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>'+escapeHtml(it.code)+'</strong> <span style="color:var(--muted);margin-right:8px">'+escapeHtml(it.title)+'</span></div><div style="color:var(--muted)">'+((it.brands&&it.brands.length)? it.brands.join(' · '):'عام')+'</div></div>';
      row.onclick = ()=> { document.getElementById('codeInput').value = it.code; document.body.removeChild(overlay); };
      list.appendChild(row);
    });
  }
  search.addEventListener('input', (e)=> render(e.target.value));
  sysSel.addEventListener('change', ()=> render(search.value));
  render(filterText);
  overlay.appendChild(modal); document.body.appendChild(overlay);
}

/* ---------- Search & Analyze (Arabic output) ---------- */
function analyze(){
  const brand = document.getElementById('brand').value || 'all';
  const model = document.getElementById('model').value || '';
  const year = document.getElementById('year').value || '';
  const code = (document.getElementById('codeInput').value || '').trim().toUpperCase();
  const desc = (document.getElementById('desc').value || '').trim();
  const sysFilter = document.getElementById('system').value || 'all';
  const out = document.getElementById('outputArea'); out.innerHTML=''; document.getElementById('metaInfo').textContent = `ماركة: ${brand} · موديل: ${model||'—'} · سنة: ${year||'—'} · كود: ${code||'—'}`;

  const db = getDB();
  let results = [];

  // 1) exact code match
  if(code){
    const exact = db.filter(it => (it.code||'').toString().toUpperCase() === code);
    if(exact.length) results = results.concat(exact);
    else {
      // prefix/contains match
      const prefix = code.replace(/[^A-Z0-9]/g,'').toUpperCase();
      const alt = db.filter(it => ((it.code||'')+'').toUpperCase().includes(prefix));
      results = results.concat(alt);
    }
  }

  // 2) description keyword match
  if(desc){
    const toks = desc.toLowerCase().split(/\s+/).filter(t=>t.length>2);
    const matched = db.filter(it=>{
      const hay = (it.title||'') + ' ' + (it.description||'') + ' ' + (it.causes||[]).join(' ') + ' ' + (it.solutions||[]).join(' ');
      const low = hay.toLowerCase();
      return toks.some(tok => low.includes(tok));
    });
    matched.forEach(m=>{ if(!results.some(r=>r.code===m.code)) results.push(m); });
  }

  // 3) apply system filter and brand filter (if brand specific)
  if(sysFilter !== 'all'){
    results = results.filter(r => (r.system||'') === sysFilter);
  }
  if(brand && brand !== 'all'){
    // include if brand matches or general 'all'
    results = results.filter(r => {
      if(!r.brands || r.brands.length===0) return true;
      return r.brands.includes('all') || r.brands.map(b=>b.toLowerCase()).includes(brand.toLowerCase());
    });
  }

  // 4) fallback search if still empty
  if(results.length===0){
    const q = (code || desc).toLowerCase();
    if(q){
      const fallback = db.filter(it => (((it.code||'')+' '+(it.title||'')+' '+(it.description||'')).toLowerCase().includes(q)));
      fallback.forEach(m=>{ if(!results.some(r=>r.code===m.code)) results.push(m); });
    }
  }

  if(results.length===0){
    out.innerHTML = `<div class="empty"><div style="font-weight:700;margin-bottom:8px">لم نعثر على نتيجة مباشرة</div><div>جرب كتابة الكود مثل <strong>P0300</strong> أو وصف المشكلة بكلمات أوضح، أو اضغط "اختر كود" لتصفح القائمة.</div></div>`;
    return;
  }

  // Present results
  results.forEach(item=>{
    const el = document.createElement('div'); el.className='fault';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="color:var(--muted);font-size:13px">الكود</div>
          <div style="font-size:18px;font-weight:800">${escapeHtml(item.code)}</div>
        </div>
        <div style="text-align:left">
          <div style="font-size:13px;color:var(--muted)">${(item.brands && item.brands.length)? item.brands.join(' · '):'عام'}</div>
          <div style="font-weight:800;margin-top:6px">${escapeHtml(item.title)}</div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted)">${escapeHtml(item.description||'')}</div>
      <div style="margin-top:10px"><strong>الأسباب المحتملة:</strong><ul>${(item.causes||[]).map(c=>`<li>${escapeHtml(c)}</li>`).join('')}</ul></div>
      <div style="margin-top:6px"><strong>الحلول الممكنة:</strong><ul>${(item.solutions||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul></div>
    `;
    out.appendChild(el);
  });

  // Analysis synthesis in Arabic
  const systems = Array.from(new Set(results.map(r=>r.system))).join(' · ') || 'متعددة';
  const codesList = Array.from(new Set(results.map(r=>r.code))).join(', ');
  const analysisLines = [];
  analysisLines.push(`تحليل عام: بناءً على المدخلات (ماركة: ${brand}, موديل: ${model||'غير محدد'}, سنة: ${year||'غير محددة'}) والأكواد/الوصف (${codesList})، يبدو أن الأنظمة المتأثرة: ${systems}.\n`);
  analysisLines.push(`خطوات فحص سريعة (الأساسية):\n1) فحص التوصيلات الكهربائية والفيوزات ومأخذ OBD.\n2) فحص الشمعات والكويلات وفلتر الهواء والماف إذا كانت الأعراض اهتزاز/تفتفة.\n3) تنظيف حساس MAF وحساسات O2 إن لزم، ومراقبة Live data.\n4) فحص تسريبات الهواء وخراطيم السحب إن كانت رموز خليط الهواء/الوقود.\n5) للرموز المتعلقة بالناقل: اقرأ أكواد ناقل الحركة (TCM) قبل تبديل الصمامات.\n`);
  analysisLines.push(`ملاحظة: هذه توصيات مبدئية؛ إذا لم تُحل المشكلة بعد الخطوات البسيطة فيجب إجراء فحص متخصص (ضغط اسطوانات، فحص كهربائي متقدم، مراقبة Live data) لدى ميكانيكي مختص.\n`);
  const analysisText = analysisLines.join('\n');

  const analysisEl = document.createElement('div'); analysisEl.className='analysis'; analysisEl.style.marginTop='12px';
  analysisEl.innerHTML = `<h4 style="margin:0 0 8px 0;">🔎 تحليل مفصّل (بالعربية)</h4><pre class="analysis">${escapeHtml(analysisText)}</pre>`;
  out.appendChild(analysisEl);
}

/* ---------- Buttons ---------- */
document.getElementById('analyzeBtn').addEventListener('click', analyze);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('brand').value='all'; fillModels('all'); document.getElementById('year').value=''; document.getElementById('codeInput').value=''; document.getElementById('desc').value=''; document.getElementById('outputArea').innerHTML = '<div class="empty"><div style="font-weight:700;margin-bottom:8px">لم يتم إجراء تشخيص بعد</div><div>أدخل الكود أو اضغط "اختر كود" ثم اضغط "تشخيص الآن".</div></div>'; document.getElementById('metaInfo').textContent = 'لم يتم إجراء تشخيص — اضغط \"تشخيص الآن\".'; });

document.getElementById('copyBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('outputArea').innerText;
  navigator.clipboard?.writeText(txt).then(()=> alert('تم نسخ النص ✅')).catch(()=> alert('فشل النسخ — جرب متصفح أحدث'));
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const brand=document.getElementById('brand').value; const model=document.getElementById('model').value; const year=document.getElementById('year').value; const code=document.getElementById('codeInput').value; const desc=document.getElementById('desc').value;
  const resultsText = document.getElementById('outputArea').innerText;
  const payload = { brand, model, year, code, desc, resultsText, exportedAt:new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`dali_diag_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
});

/* ---------- Import external JSON DB ---------- */
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importJson').click());
document.getElementById('importJson').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text(); const json = JSON.parse(txt);
    if(!Array.isArray(json)) return alert('الملف يجب أن يكون مصفوفة JSON.');
    IMPORTED_DB = json;
    alert('تم استيراد قاعدة البيانات الخارجية بنجاح — الآن سيتم استخدامها في البحث.');
  }catch(err){ alert('فشل استيراد JSON: ' + (err.message||err)); }
});

/* ---------- Utility ---------- */
function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

/* ---------- End ---------- */
</script>
</body>
</html>
