<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dali Nadjib AI Voiture — تشخيص أكواد OBD</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#0f1720;
      --muted:#9aa4b2;
      --accent1:#ff6b6b;
      --accent2:#7c5cff;
      --accent3:#00d4ff;
      --glass: rgba(255,255,255,0.04);
      --success:#4ade80;
      --danger:#ff7b7b;
      --radius:14px;
    }
    *{box-sizing:border-box;font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 20%, rgba(124,92,255,0.10), transparent 8%),
                  radial-gradient(900px 400px at 90% 80%, rgba(0,212,255,0.06), transparent 8%),
                  var(--bg);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      min-height:100vh;
    }
    .app{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:20px;
      align-items:start;
    }

    /* SIDEBAR / FORM */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
      padding:20px;
      border-radius: var(--radius);
      box-shadow: 0 6px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    }
    h1{
      margin:0 0 8px 0;
      font-size:20px;
      letter-spacing:0.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .title-badge{
      background:linear-gradient(90deg,var(--accent2),var(--accent3));
      padding:8px 12px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      color:#020617;
    }
    p.lead{ margin:8px 0 18px 0; color:var(--muted); font-size:13px; }

    label{ display:block; font-size:13px; color:var(--muted); margin-top:12px; margin-bottom:6px; }
    input[type="text"], select, textarea {
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);
      background:var(--glass);
      color:inherit;
      outline:none;
      font-size:14px;
      resize:vertical;
    }
    textarea{ min-height:86px; }
    .row{ display:flex; gap:10px; }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:12px; cursor:pointer;
      border: none; font-weight:700; font-size:14px;
    }
    .btn-primary{
      background: linear-gradient(90deg,var(--accent2),var(--accent1));
      color:#07070b;
      box-shadow: 0 8px 28px rgba(124,92,255,0.12);
    }
    .btn-ghost{
      background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted);
    }
    .small { font-size:12px; color:var(--muted); margin-top:8px; }

    /* MAIN OUTPUTS */
    .outputs{
      display:flex; flex-direction:column; gap:16px;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      padding:18px; border-radius:14px;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px; font-size:13px; color:#071122;
      background:linear-gradient(90deg,var(--accent3),var(--accent2)); font-weight:700;
    }
    .meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px; margin-bottom:8px; flex-wrap:wrap; }

    .fault{
      border-radius:12px; padding:12px; margin-bottom:10px;
      background: linear-gradient(90deg, rgba(124,92,255,0.06), rgba(0,212,255,0.02));
      border:1px solid rgba(124,92,255,0.08);
    }
    .analysis{
      background: linear-gradient(90deg, rgba(0,0,0,0.12), rgba(255,255,255,0.01));
      padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.02);
    }
    ul{ margin:8px 0 0 0; padding-left:18px; color:#dbe8ff; }
    li{ margin:6px 0; color:#dbe8ff; }

    footer.appfoot{ text-align:center; color:var(--muted); margin-top:18px; grid-column:1/-1; }

    /* responsive */
    @media (max-width:980px){
      .app{ grid-template-columns:1fr; padding:16px; }
    }

    /* little icons */
    .icon {
      width:22px;height:22px;display:inline-block;
    }

    /* empty state */
    .empty { text-align:center; color:var(--muted); padding:28px; border-radius:12px; border:1px dashed rgba(255,255,255,0.03); }

    /* result header */
    .res-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Dali Nadjib AI Voiture">
    <!-- LEFT FORM -->
    <aside class="card" aria-labelledby="app-title">
      <h1 id="app-title"><span class="title-badge">Dali Nadjib AI</span> تشخيص أعطال السيارات</h1>
      <p class="lead">أدخل بيانات السيارة وكود OBD أو وصف الحالة، واحصل على أعطال محتملة، تحليل بالعربية، وحلول مفصّلة.</p>

      <label for="brand">نوع السيارة / الماركة</label>
      <select id="brand" aria-label="نوع السيارة">
        <option value="all">عام — غير محدد</option>
        <option>Renault</option>
        <option>Peugeot</option>
        <option>Toyota</option>
        <option>Hyundai</option>
        <option>Mercedes</option>
        <option>Volkswagen</option>
        <option>BMW</option>
        <option>Other</option>
      </select>

      <div style="display:flex;gap:10px;">
        <div style="flex:1">
          <label for="model">الموديل</label>
          <input id="model" type="text" placeholder="مثال: Clio, 208, Corolla..." />
        </div>
        <div style="width:120px;">
          <label for="year">سنة الصنع</label>
          <input id="year" type="text" placeholder="مثال: 2015" />
        </div>
      </div>

      <label for="code">كود OBD (مثال: P0300)</label>
      <input id="code" type="text" placeholder="P0300" />

      <label for="desc">وصف حالة السيارة (بإيجاز)</label>
      <textarea id="desc" placeholder="أكتب هنا: مثلاً 'المحرك يهتز عند التشغيل، ضوء المحرك مضيء'"></textarea>

      <div style="display:flex;gap:10px;margin-top:14px;">
        <button class="btn btn-primary" id="analyzeBtn" title="تشخيص">🔎 تشخيص الآن</button>
        <button class="btn btn-ghost" id="resetBtn" title="مسح">♻️ مسح</button>
      </div>

      <div class="small">نقطة مهمة: التطبيق يعتمد على قاعدة بيانات داخل الملف. في حال لم يظهر الكود، جرّب كتابة الكود بدقة أو وصف المشكلة بكلمات عربية بسيطة.</div>
    </aside>

    <!-- RIGHT OUTPUTS -->
    <main class="outputs">
      <section class="panel" id="resultPanel">
        <div class="res-head">
          <div style="display:flex;gap:12px;align-items:center;">
            <div class="badge">نتيجة التشخيص</div>
            <div class="meta" id="metaInfo">لا توجد نتيجة — اضغط "تشخيص الآن".</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" id="exportBtn" title="تصدير النتيجة كـ JSON">📤 تصدير</button>
            <button class="btn btn-ghost" id="copyBtn" title="نسخ ملخص">📋 نسخ</button>
          </div>
        </div>

        <div id="outputArea" style="margin-top:14px;">
          <div class="empty">
            <div style="font-size:18px; font-weight:700; margin-bottom:6px">لم يتم إجراء تشخيص بعد</div>
            <div>أدخل كود OBD أو وصف الحالة ثم اضغط "تشخيص الآن".</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h3 style="margin:0 0 8px 0;">قواعد سريعة / ملاحظات</h3>
        <ul>
          <li>الأكواد العامة (P0xxx) تعمل على معظم السيارات. الأكواد P1xxx قد تكون خاصة بالشركة.</li>
          <li>إذا لم تجد الكود: أدخله يدوياً ثم تحقق من تهجئته، أو اكتب وصف الحالة وسيحاول النظام المطابقة.</li>
          <li>هذه نسخة تعمل محليًا — يمكن رفع قاعدة بيانات JSON أكبر لاحقًا.</li>
        </ul>
      </section>

      <footer class="appfoot">© <strong>Dali Nadjib AI Voiture</strong> — واجهة تشخيص OBD بالعربية</footer>
    </main>
  </div>

  <script>
    // قاعدة بيانات مبسطة — يمكنك توسيعها لاحقًا أو استيراد JSON كبير
    const DB = [
      {
        code:"P0300",
        title:"خلل احتراق عشوائي (Misfire)",
        brands:["all"],
        system:"محرك",
        description:"اهتزاز في المحرك أو فقدان قوة بسبب احتراق غير منتظم في أسطوانات متعددة.",
        causes:["شمعات احتراق تالفة","كويلات اشتعال معطوبة","بخاخات متسخة أو مسدودة","تسريب هواء في النظام","ضغط اسطوانات منخفض"],
        solutions:["فحص وتغيير شمعات الاحتراق","اختبار الكويلات واستبدال المعطوبة","تنظيف أو استبدال البخاخات","فحص تسريبات الهواء وخراطيم السحب","قياس ضغط الاسطوانات"]
      },
      {
        code:"P0171",
        title:"خليط فقير - بنك 1 (Lean)",
        brands:["all"],
        system:"وقود / هواء",
        description:"الوحدة تتحسس خليط هواء/وقود فقير في الجانب 1.",
        causes:["تسريب هواء بعد MAF","حساس MAF معطوب أو متسخ","ضغط وقود منخفض","انسداد فلتر الوقود"],
        solutions:["تنظيف/استبدال حساس MAF","فحص ضغط مضخة الوقود","استبدال فلتر الوقود","فحص خراطيم التسريب"]
      },
      {
        code:"P0420",
        title:"كفاءة المحول الحفاز منخفضة",
        brands:["all"],
        system:"عادم",
        description:"انخفاض أداء المحول الحفاز (Catalytic converter) مما يزيد انبعاثات العادم.",
        causes:["تشبع أو تلف المحول الحفاز","حساس أكسجين معطوب","حرق غير مكتمل لفترة طويلة","تسريب عادم"],
        solutions:["فحص حساسات O2 وأستبدالها عند الضرورة","فحص المحول و استبداله إذا لزم","إصلاح مشاكل الاحتراق"]
      },
      {
        code:"P0101",
        title:"إشارة حساس تدفق الهواء (MAF) غير طبيعية",
        brands:["all"],
        system:"حساسات",
        description:"قراءات غير منطقية من حساس MAF مقارنةً بشرط الحمل.",
        causes:["حساس MAF متسخ","توصيلات كهربائية سيئة","حساس معطل"],
        solutions:["تنظيف حساس MAF","فحص التوصيلات والأسلاك","استبدال الحساس إذا تأكد العطل"]
      },
      {
        code:"P0113",
        title:"حساس درجة حرارة الهواء (IAT) إشارة عالية",
        brands:["all"],
        system:"حساسات",
        description:"الإشارة تشير إلى درجة حرارة هواء مرتفعة أو مقطوعة الدائرة.",
        causes:["حساس IAT معطوب","أسلاك مقطوعة أو مقطوعة","موضع الحساس خاطئ"],
        solutions:["فحص الحساس والأسلاك","استبدال الحساس إذا لزم"]
      },
      {
        code:"P0128",
        title:"حرارة التبريد لم تصل لدرجة التشغيل",
        brands:["all"],
        system:"تبريد",
        description:"الثرموستات عالق مفتوحًا أو نظام التدفئة/المبرد لا يعمل بشكل صحيح.",
        causes:["ثرموستات معطوب","مستشعر حرارة معطل","نقص في سائل التبريد"],
        solutions:["فحص الثرموستات واستبداله","فحص مستوى سائل التبريد","فحص حساس الحرارة"]
      },
      {
        code:"P0135",
        title:"دائرة سخان حساس الاكسجين B1S1",
        brands:["all"],
        system:"حساسات",
        description:"مشكلة في دائرة السخان لحساس الأكسجين (heater) في البنك 1، الحساس لا يسخن.",
        causes:["ريلاي/فيوز السخان مقطوع","توصيلات السخان ممزقة","حساس الاكسجين خربان"],
        solutions:["فحص الفيوز والريلاي","فحص التوصيلات","استبدال حساس O2 عند الحاجة"]
      },
      {
        code:"P0455",
        title:"تسريب كبير في نظام التبخر (EVAP)",
        brands:["all"],
        system:"evap",
        description:"تسريب كبير في نظام تبخر الوقود—غطاء الخزان أو خط متضرر.",
        causes:["غطاء وقود غير محكم/مكسور","خط EVAP متضرر","صمام EVAP معطوب"],
        solutions:["تأكد من إحكام غطاء البنزين","فحص خراطيم EVAP واستبدالها","فحص صمام EVAP"]
      },
      // مثال على كود مخصص لماركة
      {
        code:"P1336",
        title:"خلل إشارة كرنك — رموز شائعة في بعض رينو/بيجو",
        brands:["Renault","Peugeot"],
        system:"محرك",
        description:"فقدان أو عدم استقرار إشارة حساس عمود المرفق يسبب مشاكل في الاشتعال/التزامن.",
        causes:["حساس الكرنك تالف","أسلاك مقطوعة/تأكسد","مشاكل في ترس الحساس"],
        solutions:["استبدال حساس الكرنك","فحص الضفيرة والوصلات","فحص تروس ومواضع الحساس"]
      }
    ];

    // helper: find by code exact
    function findByCode(code){
      if(!code) return null;
      const c = code.trim().toUpperCase();
      return DB.find(item => item.code.toUpperCase() === c) || null;
    }

    function keywordMatch(text){
      const q = (text||"").toLowerCase();
      if(!q) return [];
      // search causes/description/title for keywords
      return DB.filter(item => {
        const hay = (item.title + " " + item.description + " " + (item.causes||[]).join(" ")).toLowerCase();
        return q.split(/\s+/).some(tok => tok.length>2 && hay.includes(tok));
      });
    }

    function analyze(){
      const brand = document.getElementById('brand').value || 'all';
      const model = document.getElementById('model').value || '';
      const year = document.getElementById('year').value || '';
      const code = document.getElementById('code').value || '';
      const desc = document.getElementById('desc').value || '';

      const output = document.getElementById('outputArea');
      output.innerHTML = '';

      // metadata
      const meta = document.getElementById('metaInfo');
      meta.textContent = `ماركة: ${brand} · موديل: ${model||'—'} · سنة: ${year||'—'} · كود: ${code||'—'}`;

      // attempt
      let found = null;
      if(code.trim()){
        found = findByCode(code);
      }

      const matchesFromDesc = keywordMatch(desc);
      let combined = [];
      if(found) combined.push(found);
      // add matches but avoid duplicates by code
      matchesFromDesc.forEach(m=>{
        if(!combined.some(c=>c.code===m.code)) combined.push(m);
      });

      // If no matches, try fuzzy code prefix match (e.g., user typed "0300")
      if(!found && code.trim()){
        const prefix = code.replace(/[^A-Za-z0-9]/g,'').toUpperCase();
        const alt = DB.filter(item => item.code.toUpperCase().includes(prefix));
        alt.forEach(m=>{ if(!combined.some(c=>c.code===m.code)) combined.push(m); });
      }

      // If still empty, try generic search by description words
      if(combined.length===0 && desc.trim()){
        const more = keywordMatch(desc);
        more.forEach(m=>{ if(!combined.some(c=>c.code===m.code)) combined.push(m); });
      }

      if(combined.length===0){
        // no results — show helpful fallback
        const e = document.createElement('div');
        e.className = 'empty';
        e.innerHTML = `<div style="font-weight:700;margin-bottom:8px">لم نعثر على تطابق مباشر</div>
          <div>جرب كتابة الكود بصيغة مثل <strong>P0300</strong> أو وصف الحالة بكلمات أوضح. يمكنك أيضًا استيراد قاعدة بيانات JSON أكبر لاحقًا.</div>`;
        output.appendChild(e);
        return;
      }

      // show list of found faults
      combined.forEach(item=>{
        const wrp = document.createElement('div');
        wrp.className = 'fault';
        wrp.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div>
              <div style="color:var(--muted);font-size:13px">الكود</div>
              <div style="font-size:18px;font-weight:800">${item.code}</div>
            </div>
            <div style="text-align:left">
              <div style="font-size:13px;color:var(--muted)">${item.brands && item.brands.length ? item.brands.join(' · ') : 'عام'}</div>
              <div style="font-weight:700;margin-top:6px">${item.title}</div>
            </div>
          </div>
          <div style="margin-top:10px;color:var(--muted);">${item.description || ''}</div>
          <div style="margin-top:10px">
            <strong>الأسباب المحتملة:</strong>
            <ul>${(item.causes||[]).map(c=>`<li>${c}</li>`).join('')}</ul>
          </div>
          <div style="margin-top:10px">
            <strong>الحلول الممكنة:</strong>
            <ul>${(item.solutions||[]).map(s=>`<li>${s}</li>`).join('')}</ul>
          </div>
        `;
        output.appendChild(wrp);
      });

      // analysis block: synthesize Arabic explanation
      const analysis = document.createElement('div');
      analysis.className = 'analysis';
      const codesList = combined.map(c=>c.code).join(', ');
      const systems = Array.from(new Set(combined.map(c=>c.system))).join(' · ');
      let analysisText = `تحليل عام: بناءً على المدخلات (ماركة: ${brand}, موديل: ${model||'غير محدد'}, سنة: ${year||'غير محددة'}) والكود/الأوصاف (${codesList})، يمكن استنتاج أن المشكلة على الأغلب مرتبطة بـ: ${systems}.\n\n`;
      // add short tailored advice
      analysisText += `نصائح فورية:\n`;
      analysisText += `• ابدأ بفحص العناصر السهلة: شمعات الاحتراق، توصيلات الحساسات، مستوى الوقود وسوائل التبريد.\n`;
      analysisText += `• إن كان ضوء المحرك مضيء وظهرت كود P0300 أو P0171 فافحص شمعات وفتحات البخاخ والماف.\n`;
      analysisText += `• ان لم تكن متأكدًا من الكود، قم بتسجيل الأعراض بالتفصيل واطلب فحص OBD لدى ميكانيكي مختص لقراءة الدرجات الوقتيّة (Live data).\n\n`;
      analysisText += `ملاحظة: الحلول المدرجة أعلاه هي حلول مبدئية. قد يحتاج التشخيص إلى أدوات (فحص ضغط الاسطوانات، فحص كهربائي) وإلى فني مختص عند تعذّر الحل البسيط.`;

      // format into paragraphs
      analysis.innerHTML = `<h4 style="margin:0 0 8px 0;">🔍 تحليل موجز بالعربية</h4><pre style="white-space:pre-wrap;margin:0;line-height:1.5;color:#dfeeff">${analysisText}</pre>`;
      output.appendChild(analysis);
    }

    // buttons
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      document.getElementById('brand').value = 'all';
      document.getElementById('model').value = '';
      document.getElementById('year').value = '';
      document.getElementById('code').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('outputArea').innerHTML = '<div class="empty"><div style="font-weight:700;margin-bottom:8px">لم يتم إجراء تشخيص بعد</div><div>أدخل كود OBD أو وصف الحالة ثم اضغط \"تشخيص الآن\".</div></div>';
      document.getElementById('metaInfo').textContent = 'لا توجد نتيجة — اضغط \"تشخيص الآن\".';
    });

    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const output = document.getElementById('outputArea').innerText;
      navigator.clipboard?.writeText(output).then(()=> alert('تم نسخ ملخص النتيجة إلى الحافظة ✅')).catch(()=> alert('تعذر النسخ — الرجاء استخدام المتصفح الحديث.'));
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      // gather current displayed results into JSON
      const brand = document.getElementById('brand').value || 'all';
      const model = document.getElementById('model').value || '';
      const year = document.getElementById('year').value || '';
      const code = document.getElementById('code').value || '';
      const desc = document.getElementById('desc').value || '';
      const resultsText = document.getElementById('outputArea').innerText || '';
      const payload = { brand, model, year, code, desc, resultsText, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dali_diagnostic_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // init empty UI
    document.getElementById('resetBtn').click();
  </script>
</body>
</html>
